# 页面级取消机制测试指南

## 测试目的
验证新实施的页面级取消机制能够从根本上解决多页面查询无法取消的问题，确保`page.evaluate()`调用能够被立即中断。

## 核心改进说明

### 1. 页面级取消检查脚本注入
- **位置**: `src/renderer/browser-manager.js` - `injectCancelCheckScript()`
- **功能**: 在每个页面加载时注入取消检查机制
- **检查频率**: 每10ms检查一次localStorage中的取消标志
- **生效范围**: 页面内的所有JavaScript操作

### 2. Node.js与页面层的通信机制
- **位置**: `src/renderer/renderer.js` - `setPageLevelCancelSignal()`
- **功能**: 将Node.js层的取消状态同步到页面的localStorage
- **触发时机**: 用户点击取消按钮时立即设置，查询开始/结束时重置

### 3. 关键page.evaluate调用的内部取消检查
已对以下关键操作添加页面级取消检查：
- **查询按钮点击**: performSearch & performAdvancedSearch
- **翻页操作**: 点击下一页按钮
- **数据获取**: 提取表格数据的循环操作
- **按钮查找**: 分页按钮搜索过程

## 测试步骤

### 测试用例1：查询按钮点击阶段取消
1. 启动应用并设置会产生多页结果的查询条件
2. 点击"开始查询"
3. **在页面开始处理查询按钮点击时立即点击取消**
4. 观察是否立即停止（预期：1秒内停止）

**预期结果：**
- 控制台显示：`[页面级] 查询按钮点击操作被取消`
- 查询立即停止，不会进入后续处理阶段

### 测试用例2：数据获取阶段取消
1. 执行会产生多页结果的查询
2. 等待开始处理第一页数据
3. **在数据提取过程中点击取消**

**预期结果：**
- 控制台显示：`[页面级] 数据获取操作被取消` 或 `[页面级] 处理第X行时被取消`
- 数据提取立即停止

### 测试用例3：翻页操作阶段取消
1. 执行会产生多页结果的查询
2. 等待开始翻页到第2页
3. **在翻页操作过程中点击取消**

**预期结果：**
- 控制台显示：`[页面级] 翻页操作被取消` 或 `[页面级] 查找翻页按钮时被取消`
- 翻页操作立即停止

### 测试用例4：网络缓慢时的取消响应
1. 在网络环境较慢的情况下执行多页查询
2. 等待页面响应缓慢时点击取消
3. 验证即使网络缓慢，取消仍能快速响应

**预期结果：**
- 不受网络速度影响，取消信号在1-2秒内生效
- 页面内操作被立即中断

## 技术验证点

### 1. 页面级取消机制是否正确注入
检查控制台是否出现：
```
[页面级] 取消检查机制已注入并启动
页面级取消检查脚本注入成功
```

### 2. 取消信号传递是否正常
检查控制台是否出现：
```
页面级取消信号已设置为: true
[页面级] 直接设置取消状态为true
[页面级] 检测到取消信号
```

### 3. 各个关键操作是否能被中断
验证每个关键操作都有对应的取消日志：
- `[页面级] 查询按钮点击操作被取消`
- `[页面级] 数据获取操作被取消`
- `[页面级] 翻页操作被取消`
- `[页面级] 处理第X行时被取消`

## 性能期望对比

| 阶段 | 原问题 | 目标改进 | 预期效果 |
|------|--------|----------|----------|
| 查询按钮点击 | 可能阻塞10-30秒 | 1秒内中断 | 立即响应 |
| 数据获取循环 | 无法中断 | 每行检查取消 | 最多处理完当前行 |
| 翻页操作 | 长时间阻塞 | 立即检查取消 | 翻页前就能中断 |
| 按钮查找 | DOM操作阻塞 | 循环中检查取消 | 查找过程可中断 |

## 故障排除

### 如果取消仍然缓慢
1. **检查页面级脚本是否注入成功**
   - 查看控制台是否有注入成功的日志
   - 检查`window.pageLevelCancel`对象是否存在

2. **检查localStorage通信是否正常**
   - 在控制台执行：`localStorage.getItem('globalShouldStop')`
   - 应该在取消时返回`'true'`

3. **检查页面级检查是否工作**
   - 在控制台执行：`window.pageLevelCancel.shouldCancel()`
   - 取消时应该返回`true`

4. **网络问题**
   - 如果网络极慢，某些page.evaluate调用仍可能延迟
   - 但延迟应该显著减少（从30秒降到1-3秒）

## 成功验证标准

✅ 页面级取消脚本成功注入  
✅ localStorage通信机制正常工作  
✅ 查询按钮点击阶段可立即取消  
✅ 数据获取阶段可快速中断  
✅ 翻页操作阶段可立即停止  
✅ 取消响应时间在1-3秒内  
✅ 控制台显示相应的页面级取消日志  

## 注意事项

1. **页面刷新后需要重新注入**: 如果页面被刷新，需要确保脚本重新注入
2. **localStorage访问权限**: 某些情况下localStorage可能无法访问，有fallback机制
3. **多标签页情况**: 每个标签页都会独立注入取消检查机制
4. **浏览器兼容性**: 依赖于现代浏览器的localStorage和页面脚本支持

这种页面级取消机制从根本上解决了`page.evaluate()`阻塞无法取消的问题，是最彻底的解决方案。 